{"version":3,"file":"chat.min.js","sources":["../src/chat.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n\n/**\n * MooChat JavaScript module\n * @package\n * @copyright  2025 Brian A. Pool\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/ajax', 'core/notification', 'core/str'], function($, Ajax, Notification, Str) {\n\n    return {\n        init: function(moochatid) {\n\n            var conversationHistory = [];\n            var remainingQuestions = -1; // -1 means unlimited\n            var hasChattedOnce = false; // track if student has sent at least one message\n\n            // Load language strings\n            var strings = [];\n            Str.get_strings([\n                {key: 'questionsremaining_js', component: 'mod_moochat'},\n                {key: 'thinking_js', component: 'mod_moochat'},\n                {key: 'ratelimitreached_title', component: 'mod_moochat'},\n                {key: 'error_title', component: 'mod_moochat'},\n                {key: 'connectionerror', component: 'mod_moochat'},\n                {key: 'chatcleared', component: 'mod_moochat'},\n                {key: 'confirmclear', component: 'mod_moochat'},\n                {key: 'chattingwith', component: 'mod_moochat'}\n            ]).done(function(s) {\n                strings = s;\n            });\n\n            var messagesDiv = $('#moochat-messages-' + moochatid);\n            var inputField = $('#moochat-input-' + moochatid);\n            var sendButton = $('#moochat-send-' + moochatid);\n            var clearButton = $('#moochat-clear-' + moochatid);\n            var remainingDiv = $('#moochat-remaining-' + moochatid);\n\n            // Update remaining questions display\n            var updateRemaining = function(remaining) {\n                if (remaining >= 0) {\n                    var message = strings[0] + ': ' + remaining;\n                    remainingDiv.html('<div class=\"alert alert-info\">' + message + '</div>');\n                    remainingDiv.show();\n                } else {\n                    remainingDiv.hide();\n                }\n            };\n\n            // Send message\n            var sendMessage = function() {\n                var message = inputField.val().trim();\n\n                if (message === '') {\n                    return;\n                }\n\n                // Disable input while processing\n                inputField.prop('disabled', true);\n                sendButton.prop('disabled', true);\n\n                // Add user message to display\n                addMessage('user', message);\n\n                // Add to history\n                conversationHistory.push({\n                    role: 'user',\n                    content: message\n                });\n\n                // Clear input\n                inputField.val('');\n\n                // Show thinking indicator\n                var thinkingId = 'thinking-' + Date.now();\n                messagesDiv.append(\n                    '<div class=\"moochat-message moochat-assistant\" id=\"' + thinkingId + '\">' +\n                    '<em>' + strings[1] + '</em></div>'\n                );\n                scrollToBottom();\n\n                // Call API using Moodle's Ajax module\n                Ajax.call([{\n                    methodname: 'mod_moochat_send_message',\n                    args: {\n                        moochatid: moochatid,\n                        message: message,\n                        history: JSON.stringify(conversationHistory)\n                    }\n                }])[0].then(function(response) {\n                    // Remove thinking indicator\n                    $('#' + thinkingId).remove();\n\n                    if (response.error || !response.success) {\n                        // Check if this is a rate limit error\n                        if (response.remaining !== undefined && response.remaining === 0) {\n                            Notification.alert(strings[2], response.error, 'OK');\n                            inputField.prop('disabled', true);\n                            sendButton.prop('disabled', true);\n                            updateRemaining(0);\n                        } else {\n                            Notification.alert(strings[3], response.error, 'OK');\n                        }\n                    } else if (response.success && response.reply) {\n                        // Add assistant reply\n                        addMessage('assistant', response.reply);\n\n                        // Add to history\n                        conversationHistory.push({\n                            role: 'assistant',\n                            content: response.reply\n                        });\n\n                        // After first successful exchange, swap welcome message to chattingwith hint\n                        if (!hasChattedOnce) {\n                            hasChattedOnce = true;\n                            messagesDiv.find('p.moochat-welcome').text(strings[7]);\n                        }\n\n                        // Save conversation to database\n                        Ajax.call([{\n                            methodname: 'mod_moochat_save_conversation',\n                            args: {\n                                moochatid: moochatid,\n                                usermessage: message,\n                                assistantmessage: response.reply\n                            },\n                            done: function() {\n                                // Conversation saved successfully (silent)\n                            },\n                            fail: function() {\n                                // Failed to save (silent - don't interrupt user experience)\n                            }\n                        }]);\n\n                        // Update remaining questions\n                        if (response.remaining !== undefined) {\n                            remainingQuestions = response.remaining;\n                            updateRemaining(remainingQuestions);\n\n                            // Disable if no questions left\n                            if (remainingQuestions === 0) {\n                                inputField.prop('disabled', true);\n                                sendButton.prop('disabled', true);\n                            }\n                        }\n                    }\n\n                    // Re-enable input (unless disabled by rate limit)\n                    if (remainingQuestions !== 0) {\n                        inputField.prop('disabled', false);\n                        sendButton.prop('disabled', false);\n                        inputField.focus();\n                    }\n                }).catch(function() {\n                    $('#' + thinkingId).remove();\n                    Notification.alert(strings[3], strings[4], 'OK');\n                    inputField.prop('disabled', false);\n                    sendButton.prop('disabled', false);\n                });\n            };\n\n            // Add message to display\n            var addMessage = function(role, content) {\n                var messageClass = role === 'user' ? 'moochat-user' : 'moochat-assistant';\n                var formattedContent = formatMessage(content);\n                var messageHtml = '<div class=\"moochat-message ' + messageClass + '\">' +\n                                 formattedContent + '</div>';\n                messagesDiv.append(messageHtml);\n                scrollToBottom();\n            };\n\n            // Format message content with line breaks and basic formatting\n            var formatMessage = function(text) {\n                // Escape HTML first\n                var escaped = escapeHtml(text);\n\n                // Only format if it's a longer response (more than 100 chars or has multiple sentences)\n                var sentenceCount = (text.match(/[.!?]+/g) || []).length;\n\n                if (text.length < 100 && sentenceCount <= 3) {\n                    // Short response - return as-is\n                    return escaped;\n                }\n\n                // Handle markdown bold (**text** or __text__)\n                escaped = escaped.replace(/\\*\\*([^*]+)\\*\\*/g, '<strong>$1</strong>');\n                escaped = escaped.replace(/__([^_]+)__/g, '<strong>$1</strong>');\n\n                // Handle markdown italic (*text* or _text_) - but not bullet points\n                escaped = escaped.replace(/\\*([^*\\n]+)\\*/g, '<em>$1</em>');\n\n                // Convert double line breaks to paragraphs\n                escaped = escaped.replace(/\\n\\n+/g, '</p><p>');\n\n                // Convert single line breaks to <br>\n                escaped = escaped.replace(/\\n/g, '<br>');\n\n                // Wrap in paragraph tags\n                escaped = '<p>' + escaped + '</p>';\n\n                // Handle numbered lists (1. 2. 3.)\n                escaped = escaped.replace(/(\\d+)\\.\\s/g, '<br><strong>$1.</strong> ');\n\n                // Handle bullet points at start of line (- or * followed by space)\n                escaped = escaped.replace(/<br>[-*]\\s+/g, '<br>• ');\n                escaped = escaped.replace(/<p>[-*]\\s+/g, '<p>• ');\n\n                return escaped;\n            };\n\n            // Scroll to bottom of messages\n            var scrollToBottom = function() {\n                messagesDiv.scrollTop(messagesDiv[0].scrollHeight);\n            };\n\n            // Escape HTML\n            var escapeHtml = function(text) {\n                var div = document.createElement('div');\n                div.textContent = text;\n                return div.innerHTML;\n            };\n\n            // Clear chat (visual only - doesn't reset server counter)\n            var clearChat = function() {\n                conversationHistory = [];\n                hasChattedOnce = false;\n                messagesDiv.html('<p class=\"moochat-welcome\">' + strings[5] + '</p>');\n                inputField.val('').focus();\n                // Note: remaining questions counter stays the same\n            };\n\n            // Event handlers\n            sendButton.on('click', sendMessage);\n\n            inputField.on('keypress', function(e) {\n                if (e.which === 13 && !e.shiftKey) {\n                    e.preventDefault();\n                    sendMessage();\n                }\n            });\n\n            clearButton.on('click', function() {\n                if (confirm(strings[6])) {\n                    clearChat();\n                }\n            });\n\n            // Focus input on load\n            inputField.focus();\n        }\n    };\n});\n"],"names":["define","$","Ajax","Notification","Str","init","moochatid","conversationHistory","remainingQuestions","hasChattedOnce","strings","get_strings","key","component","done","s","messagesDiv","inputField","sendButton","clearButton","remainingDiv","updateRemaining","remaining","message","html","show","hide","sendMessage","val","trim","prop","addMessage","push","role","content","thinkingId","Date","now","append","scrollToBottom","call","methodname","args","history","JSON","stringify","then","response","remove","error","success","undefined","alert","reply","find","text","usermessage","assistantmessage","fail","focus","catch","messageHtml","formatMessage","escaped","escapeHtml","sentenceCount","match","length","replace","scrollTop","scrollHeight","div","document","createElement","textContent","innerHTML","on","e","which","shiftKey","preventDefault","confirm"],"mappings":"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"}